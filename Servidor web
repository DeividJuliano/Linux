# Criando máquina virtual na Azure, Home, Virtual machine, preencha os campos, modalidade gratuita.
# Escolha a imagem Ubuntu Server 24.04 LTS -64 Gen2 (não escolha o ARM64), libere as portas 80,22 e 443.
# Review + e create

# Usando o WSL, (windows 11) vá no cmd 
  wsl -- list --online
  wsl -- install -d Ubuntu-24.04

#depois de instalado é necessário atualizar.

sudo apt-get update
sudo apt-get upgrade -y

#instalar o docker no ubuntu siga documentaçao official
curl -fsSL https://get.docker.com -o get-docker.sh     # baixar o script de configuração
sudo sh ./get-docker.sh --dry-run   # rodar o script
sudo docker --version   #saber a versão do docker

mkdir App   #cria a pasta App
cd App/    #entra na pasta App
nano index.html     #arquivo da aplicação cole um texto em html para teste e salve (ctrl o , enter, ctrl x) 
ls #para visualizar or arquivo


#para o arquivo rodar é necssário ter ou SO para ouvir as requisições http que poderia ser um servidor apache, nginx e afins.., 
#porém iremos fazer o arquivo rodar encapsulado em um container. Para criar um container é necessário um arquivo de configuração do container 
#com as especificações de aplicação, arquivos que estarão contidos nele
nano dockerfile   #arquivo de configuração do containere

# No arquivo do docker file adicione esses parametros, ou no site oficial da imagem siga as instruções de como usa-la how to use this image
FROM httpd:latest
WORKDIR /usr/local/apache2/htdocs/
COPY . /usr/local/apache2/htdocs/
EXPOSE 80

#salve ctrl o ctrl x, na pasta App de um ls deve aparecer dockerfile  index.html 
sudo docker build -t micro1:1.0 .     #constrói uma imagem apartir do parametros especificados, -t é onde atribui o nome para a imagem. 
#Para ser compartilhado no dockerhub pela internet seria necessário criar um usuário, se o dockerfile estiver em outro diretório seria
# neccessário informar o caminho / no lugar do ponto e o camimho.
# Pressione enter e depois da conclusão da imgem sudo docker images , irá  mostrar a imagem criada, 

sudo docker run -d -p 80:80 --name micro1 micro1:1.0  #startar a imagem -d é para rodar em segundo plano, -p porta, 80 porta do host 80 porta do container, 
# --name atribui nome depois nome e versão(TAG) caso der erro de porta usada, use  
sudo docker ps -l # para lista os docker rodando exclua o docker 
sudo docker ps  #
sudo docker rm xxxx --force   #exclui o docker xxxx de forma forçada  
sudo docker rmi --force  xxxx   #exclui a image do docker
sudo docker images  #saber as images
sudo systemctl status xxxx  #para saber se tem um serviço rodando, na porta 80, exclua a aplicação com esse comando sudo apt-get remove xxxx 
#repita o comando para subir sua aplicação sudo docker run -d -p 80:80 --name micro1 micro1:1.0  teste digitando o ip da sua máquina(servidor)

#Para fazer de forma automatizada pelo GitLab (similar ao GitHub)
#Necessário ter uma conta no GitLab e ele deve se comunicar com a sua aplicação.
#Log na sua conta, New project/repositório, Create blank project, Project name (xxxx), mantenha os paramentros em Project URL e Projec slug, 
# Project deployment target não altere, Visibility Level marque Public, Project Configuration desmarque o Initialize......README, clique em Create project

#É necessário que tudo que aconteça no servidor também aconteça no GitLab, para haver esse vinculo devemos cria o Runner. Cada Runner serve
#para um projeto específico, vá em Settings, CI/CD, Runners, New project Runner, TAG (insira um nome, ou protocolo de integração exemplo WSL) 
#Runner desrption(opcional), Create Runner, informe em qual plataforma a aplicação está rodando. Apartir de então siga os passos orientado pelo 
#GitLab  (é necessário ter instalado o GitLab-runner registrer) Step 1, Step 2.....copie e cole os comandos. Em alguns comando use o sudo no início. 
#Dessa forma será vinculado o GitLab (repositório  com o servidor) vá apertando enter e lendo as informações. Pedirá que você entre com um executor
#digite shell que é o mais universal e enter (talvez pode da error pois se você estiver usando o WSL devido não ser o shell apropriado do linux. 
#Digite sudo gitlab-runner run


#Crie uma aplicação na sua máquina, crie uma pasta, ex: testemicro1, rode o vscode nessa pasta (no terminal digite code .) 
#Crie uma pasta chamada App dentro da pasta testemicro, insira um código dentro dessa pasta (deve ser arquivo html) index.html  
# Fora do App porém na pasta testemicro1 crie um arquivo dockerfile com os parametros do Dockerfile que já criamos
FROM httpd:latest
WORKDIR /usr/local/apache2/htdocs/
COPY . /usr/local/apache2/htdocs/
EXPOSE 80

#Agora é necessário criar um pipeline para definir o que vai ser iniciado no servidor na pasta testemicro1 crie um arquivo 
#.gitlab-ci.yml (defina os pararmetros, será necessário pesquisar o procedimento) * o profesor não conseguiu fazer de forma automática que manualmente seria 
git init --initial-branch=main
git remote add origin https://endereço ou url do lab que contém os paramentros da apliaçao
git add .  
git coommit-n "App v.10"
git push comit --set-upstream origin main  #talvez pedirá para logar ou dará erro porém mesmo assim irá subir 

#para fazer de forma automática
sudo uname -a #conferi a distribuição do linux
sudo apt-get update
sudo apt-get upgrade -y  #após esse comando irá atualizar 
curl -fsSL https://get.docker.com -o get-docker.sh  #baixa o script para realizar a automação de configuração
sudo sh get-docker.sh    #executar o script de configuração, após a instalação de um sudo docker --version se aparecer a versão é por que deu certo 
sudo curl -L "https:/.........../script.deb.sh | sudo bash    #copie e cole o comando similar seguindo o site oficial do docker
sudo apt install gitlab-runner #instalar o runner
# vá no seu GitLab.com, Build, Settings, CI/CD, Runners, clique no lápis para editar seu projeto.. preencha os parametros conforme o projeto nos campos Tag,
#Runner description e clique em Create runner. clique em Linux e siga o tutorial do docker step1, step2....acrescente sudo nos comandos, é necessário que os 
#dados stejam tudo ok tag, nome e também é necessário consulta permissão que o GitLab tem para mexer no servidor cat /etc/passwd
sudo usermod -aG docker gitlab-runner    #dar permissão ao usuário gitlab-runner para mexer no servidor. confira usando  cat /etc/passwd
#no vscode de um  
git add .     
git commit -n "App v.1 - GCP"
git push --set-upstream origin main
# confira no GitLab.com Project, Build, Pipilines deverá ficar Status Running, clique em Running, em Build, clique em docker_images para visualizar, depois
#em deploy para visualizar também.
# No GCP para visulalizar o servidor na VM digite o IP externo dele no navegador, caso apresente problemas para acessar pode ser o Firewall, vá em Instâncias
# VM, Firewalls, Editar, e habilite Allow HTTP traffic e Allow HTTPS traffic e Salvar. Agore tente acessar o navegador, Se aparecer It works está ok na parte 
# do servidor porém era para conter os arquivos. No VSCODE analise a pastas com os arquivos index.html  .gitlab-ci.yml  dockerfile   (neste caso o erros estava 
# no dockerfile o correto é  COPY /App/. /usr/local/apache2/htdocs./  altere e comite de novo   git add .   git commit -n "App v.1 corrigido - GCP"   
git push --set-upstream origin main  #poderá ocorrer problemas com os jobs se tiver os mesmo nome, devido o docker está em execução.

  


  
  
  #Usar um containner (docker hub e afins algumas imagens base estão disponibilizads aqui. oracle, linux, mysql, apache, ...) através dessas 
#imagens é possivel customizar, integrar para fazer funcionar as aplicações,
